<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pente de Garage - Calculateur</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: system-ui, -apple-system, sans-serif;
        background: #f5f5f5;
        color: #333;
        padding: 20px;
        line-height: 1.6;
      }

      #app {
        max-width: 1200px;
        margin: 0 auto;
      }

      h1 {
        font-size: 2rem;
        margin-bottom: 20px;
        color: #2c3e50;
      }

      h2 {
        font-size: 1.5rem;
        margin: 20px 0 10px;
        color: #34495e;
      }

      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .input-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #555;
      }

      input[type="number"] {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
        transition: border-color 0.2s;
      }

      input[type="number"]:focus {
        outline: none;
        border-color: #3498db;
      }

      .canvas-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
      }

      canvas {
        display: block;
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .result {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .result h2 {
        margin-top: 0;
      }

      .status {
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 10px;
        font-weight: 500;
      }

      .status.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .details {
        font-size: 0.9rem;
        color: #666;
        margin-top: 10px;
      }

      @media (max-width: 768px) {
        .container {
          grid-template-columns: 1fr;
        }
        
        h1 {
          font-size: 1.5rem;
        }
        
        h2 {
          font-size: 1.2rem;
        }
      }
    </style>
  </head>
  <body>
    <div id="app"></div>
    <script>
      // LocalStorage keys
      const STORAGE_KEY = 'pente-garage-data';

      // Default values
      const defaultData = {
        garage: {
          length: 500,
          height: 15,
          slopeStart: 15,
          slopeMiddle: 0,
          slopeEnd: 15
        },
        vehicle: {
          length: 450,
          wheelbase: 270,
          groundClearance: 15
        }
      };

      // Load data from localStorage or use defaults
      function loadData() {
        const saved = localStorage.getItem(STORAGE_KEY);
        return saved ? JSON.parse(saved) : defaultData;
      }

      // Save data to localStorage
      function saveData(data) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      }

      // Initialize app
      let appData = loadData();

      // Create HTML structure
      document.querySelector('#app').innerHTML = `
        <h1>Calculateur de Pente de Garage</h1>
        
        <div class="container">
          <div class="section">
            <h2>Paramètres du Garage</h2>
            <div class="input-group">
              <label for="garageLength">Longueur (cm)</label>
              <input type="number" id="garageLength" value="${appData.garage.length}" min="100" step="10">
            </div>
            <div class="input-group">
              <label for="garageHeight">Hauteur totale (cm)</label>
              <input type="number" id="garageHeight" value="${appData.garage.height}" min="1" step="1">
            </div>
            <div class="input-group">
              <label for="slopeStart">Pente début (cm)</label>
              <input type="number" id="slopeStart" value="${appData.garage.slopeStart}" min="0" step="1">
            </div>
            <div class="input-group">
              <label for="slopeMiddle">Pente milieu (cm)</label>
              <input type="number" id="slopeMiddle" value="${appData.garage.slopeMiddle}" min="0" step="1">
            </div>
            <div class="input-group">
              <label for="slopeEnd">Pente fin (cm)</label>
              <input type="number" id="slopeEnd" value="${appData.garage.slopeEnd}" min="0" step="1">
            </div>
          </div>
          
          <div class="section">
            <h2>Caractéristiques du Véhicule</h2>
            <div class="input-group">
              <label for="vehicleLength">Longueur totale (cm)</label>
              <input type="number" id="vehicleLength" value="${appData.vehicle.length}" min="100" step="10">
            </div>
            <div class="input-group">
              <label for="wheelbase">Empattement (cm)</label>
              <input type="number" id="wheelbase" value="${appData.vehicle.wheelbase}" min="100" step="10">
            </div>
            <div class="input-group">
              <label for="groundClearance">Garde au sol (cm)</label>
              <input type="number" id="groundClearance" value="${appData.vehicle.groundClearance}" min="1" step="1">
            </div>
          </div>
        </div>
        
        <div class="canvas-container">
          <h2>Visualisation</h2>
          <canvas id="garageCanvas" width="800" height="400"></canvas>
        </div>
        
        <div class="result">
          <h2>Résultat</h2>
          <div id="calculationResult"></div>
        </div>
      `;

      // Get input elements
      const inputs = {
        garageLength: document.getElementById('garageLength'),
        garageHeight: document.getElementById('garageHeight'),
        slopeStart: document.getElementById('slopeStart'),
        slopeMiddle: document.getElementById('slopeMiddle'),
        slopeEnd: document.getElementById('slopeEnd'),
        vehicleLength: document.getElementById('vehicleLength'),
        wheelbase: document.getElementById('wheelbase'),
        groundClearance: document.getElementById('groundClearance')
      };

      // Add event listeners
      Object.keys(inputs).forEach(key => {
        inputs[key].addEventListener('input', handleInputChange);
      });

      function handleInputChange() {
        // Update appData
        appData.garage.length = parseFloat(inputs.garageLength.value);
        appData.garage.height = parseFloat(inputs.garageHeight.value);
        appData.garage.slopeStart = parseFloat(inputs.slopeStart.value);
        appData.garage.slopeMiddle = parseFloat(inputs.slopeMiddle.value);
        appData.garage.slopeEnd = parseFloat(inputs.slopeEnd.value);
        appData.vehicle.length = parseFloat(inputs.vehicleLength.value);
        appData.vehicle.wheelbase = parseFloat(inputs.wheelbase.value);
        appData.vehicle.groundClearance = parseFloat(inputs.groundClearance.value);
        
        // Save to localStorage
        saveData(appData);
        
        // Update visualization and calculation
        drawGarage();
        calculateClearance();
      }

      // Draw garage visualization
      function drawGarage() {
        const canvas = document.getElementById('garageCanvas');
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        
        // Clear canvas
        ctx.clearRect(0, 0, width, height);
        
        // Calculate scale
        const padding = 50;
        const scale = (width - 2 * padding) / appData.garage.length;
        const heightScale = (height - 2 * padding) / (appData.garage.height + 50);
        
        // Helper function to convert coordinates
        function toCanvasX(x) {
          return padding + x * scale;
        }
        
        function toCanvasY(y) {
          return height - padding - y * heightScale;
        }
        
        // Draw ground level
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(toCanvasX(0), toCanvasY(0));
        ctx.lineTo(toCanvasX(appData.garage.length), toCanvasY(0));
        ctx.stroke();
        
        // Draw garage slope profile (going down into garage)
        ctx.strokeStyle = '#2c3e50';
        ctx.lineWidth = 3;
        ctx.beginPath();
        
        const thirdLength = appData.garage.length / 3;
        
        // Start section (going down)
        ctx.moveTo(toCanvasX(0), toCanvasY(0));
        ctx.lineTo(toCanvasX(thirdLength), toCanvasY(-appData.garage.slopeStart));
        
        // Middle section
        ctx.lineTo(toCanvasX(thirdLength * 2), toCanvasY(-appData.garage.slopeStart - appData.garage.slopeMiddle));
        
        // End section (coming back up to garage floor)
        ctx.lineTo(toCanvasX(appData.garage.length), toCanvasY(-appData.garage.slopeStart - appData.garage.slopeMiddle - appData.garage.slopeEnd));
        
        ctx.stroke();
        
        // Fill area under slope
        ctx.fillStyle = 'rgba(52, 152, 219, 0.1)';
        ctx.beginPath();
        ctx.moveTo(toCanvasX(0), toCanvasY(0));
        ctx.lineTo(toCanvasX(thirdLength), toCanvasY(-appData.garage.slopeStart));
        ctx.lineTo(toCanvasX(thirdLength * 2), toCanvasY(-appData.garage.slopeStart - appData.garage.slopeMiddle));
        ctx.lineTo(toCanvasX(appData.garage.length), toCanvasY(-appData.garage.slopeStart - appData.garage.slopeMiddle - appData.garage.slopeEnd));
        ctx.lineTo(toCanvasX(appData.garage.length), toCanvasY(0));
        ctx.closePath();
        ctx.fill();
        
        // Draw vehicle (simplified representation)
        const vehicleY = 20; // Position above ground
        const vehicleColor = '#e74c3c';
        
        // Front overhang
        const frontOverhang = (appData.vehicle.length - appData.vehicle.wheelbase) / 2;
        
        ctx.strokeStyle = vehicleColor;
        ctx.fillStyle = vehicleColor;
        ctx.lineWidth = 2;
        
        // Draw vehicle rectangle
        ctx.fillRect(
          toCanvasX(50),
          toCanvasY(vehicleY + appData.vehicle.groundClearance + 30),
          appData.vehicle.length * scale,
          30
        );
        
        // Draw wheels
        const wheelRadius = 15;
        ctx.beginPath();
        ctx.arc(toCanvasX(50 + frontOverhang), toCanvasY(vehicleY + appData.vehicle.groundClearance), wheelRadius, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(toCanvasX(50 + frontOverhang + appData.vehicle.wheelbase), toCanvasY(vehicleY + appData.vehicle.groundClearance), wheelRadius, 0, Math.PI * 2);
        ctx.fill();
        
        // Add labels
        ctx.fillStyle = '#333';
        ctx.font = '12px sans-serif';
        ctx.fillText('Entrée', toCanvasX(0) - 20, toCanvasY(-10));
        ctx.fillText('Sortie', toCanvasX(appData.garage.length) - 20, toCanvasY(-10));
      }

      // Calculate if vehicle touches ground
      function calculateClearance() {
        const resultDiv = document.getElementById('calculationResult');
        
        // Calculate critical points
        const thirdLength = appData.garage.length / 3;
        const frontOverhang = (appData.vehicle.length - appData.vehicle.wheelbase) / 2;
        const rearOverhang = frontOverhang;
        
        // Function to get height at position x (negative = below ground level)
        function getHeightAtPosition(x) {
          if (x <= 0) return 0;
          if (x <= thirdLength) {
            return -(x / thirdLength) * appData.garage.slopeStart;
          }
          if (x <= thirdLength * 2) {
            const progress = (x - thirdLength) / thirdLength;
            return -(appData.garage.slopeStart + progress * appData.garage.slopeMiddle);
          }
          if (x <= appData.garage.length) {
            const progress = (x - thirdLength * 2) / thirdLength;
            return -(appData.garage.slopeStart + appData.garage.slopeMiddle + progress * appData.garage.slopeEnd);
          }
          return -(appData.garage.slopeStart + appData.garage.slopeMiddle + appData.garage.slopeEnd);
        }
        
        // Check multiple positions as vehicle enters and exits
        let touches = false;
        let criticalPosition = null;
        let minClearance = Infinity;
        
        // Simulate vehicle movement through garage
        const step = 5; // cm
        for (let vehiclePos = -appData.vehicle.length; vehiclePos <= appData.garage.length; vehiclePos += step) {
          // Front wheel position
          const frontWheelX = vehiclePos + frontOverhang;
          // Rear wheel position
          const rearWheelX = vehiclePos + frontOverhang + appData.vehicle.wheelbase;
          
          // Check if wheels are on the slope
          if (frontWheelX >= 0 && frontWheelX <= appData.garage.length &&
              rearWheelX >= 0 && rearWheelX <= appData.garage.length) {
            
            const frontHeight = getHeightAtPosition(frontWheelX);
            const rearHeight = getHeightAtPosition(rearWheelX);
            
            // Calculate vehicle slope (rise over run)
            const vehicleSlope = (rearHeight - frontHeight) / appData.vehicle.wheelbase;
            
            // Check critical points: front, center, rear
            const checkPoints = [
              { pos: vehiclePos, name: 'avant' },
              { pos: vehiclePos + appData.vehicle.length / 2, name: 'centre' },
              { pos: vehiclePos + appData.vehicle.length, name: 'arrière' }
            ];
            
            for (const point of checkPoints) {
              if (point.pos >= 0 && point.pos <= appData.garage.length) {
                const groundHeight = getHeightAtPosition(point.pos);
                
                // Calculate vehicle bottom height at this point
                // Coordinate system: height 0 is street level, negative values are below
                const distFromFrontWheel = point.pos - frontWheelX;
                const wheelHeightAtPoint = frontHeight + vehicleSlope * distFromFrontWheel;
                // Vehicle bottom is ground clearance distance above the wheel contact point
                const vehicleBottomHeight = wheelHeightAtPoint + appData.vehicle.groundClearance;
                
                // Clearance is the vertical distance between vehicle bottom and ground
                // Positive clearance means no collision, negative means collision
                const clearance = vehicleBottomHeight - groundHeight;
                
                if (clearance < minClearance) {
                  minClearance = clearance;
                  criticalPosition = { position: vehiclePos.toFixed(0), point: point.name };
                }
                
                if (clearance < 0) {
                  touches = true;
                }
              }
            }
          }
        }
        
        // Display result
        if (touches) {
          resultDiv.innerHTML = `
            <div class="status error">
              ⚠️ Le véhicule touche le sol lors de l'entrée/sortie
            </div>
            <div class="details">
              <p><strong>Marge minimale:</strong> ${minClearance.toFixed(1)} cm (négatif = contact)</p>
              <p><strong>Position critique:</strong> ${criticalPosition.point} du véhicule à ${criticalPosition.position} cm de l'entrée</p>
              <p><strong>Recommandation:</strong> Augmentez la garde au sol du véhicule ou réduisez les pentes du garage.</p>
            </div>
          `;
        } else {
          resultDiv.innerHTML = `
            <div class="status success">
              ✓ Le véhicule peut entrer et sortir sans problème
            </div>
            <div class="details">
              <p><strong>Marge minimale:</strong> ${minClearance.toFixed(1)} cm</p>
              <p><strong>Position critique:</strong> ${criticalPosition.point} du véhicule à ${criticalPosition.position} cm de l'entrée</p>
              <p><strong>Statut:</strong> Dégagement suffisant pour une utilisation sécurisée.</p>
            </div>
          `;
        }
      }

      // Initial render
      drawGarage();
      calculateClearance();
    </script>
  </body>
</html>
